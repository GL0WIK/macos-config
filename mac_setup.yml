---
- name: Configuration de mon Mac
  hosts: localhost
  connection: local
  become: false  # Pas besoin de sudo pour la plupart des actions

  vars:
    homebrew_packages:
      - git
      - tree
      - telnet
      - terraform
    homebrew_casks:
      - 4k-video-downloader+
      - aldente
      - chatgpt
      - cleanmymac
      - dbeaver-community
      - discord
      - google-chrome
      - linearmouse
      - maccy
      - windows-app
      - obsidian
      - vivid
      - vlc
      - visual-studio-code
    mas_apps:
      - { name: "Dashlane Password Manager", id: 517914548 }
      - { name: "Jomo - Meilleur temps d'Ã©cran", id: 1609960918 }
      - { name: "LanScan", id: 472226235 }
      - { name: "WireGuard", id: 1451685025 }
      - { name: "Transmit 5", id: 1436522307 }
    dotfiles_repo: "https://github.com/GL0WIK/dotfiles.git"
    dotfiles_path: "{{ ansible_env.HOME }}/.dotfiles"

  tasks:

    - name: "ğŸ”§ Installer Homebrew"
      shell: |
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      args:
        creates: /opt/homebrew/bin/brew  # Ne s'exÃ©cute que si Homebrew n'est pas dÃ©jÃ  installÃ©

    - name: "ğŸ”„ Mettre Ã  jour Homebrew"
      command: brew update

    - name: "ğŸº Installer des paquets Homebrew"
      homebrew:
        name: "{{ homebrew_packages }}"
        state: present

    - name: "ğŸ“¦ Installer des applications Homebrew Cask"
      homebrew_cask:
        name: "{{ homebrew_casks }}"
        state: present

    - name: "ğŸ›’ Installer des applications Mac App Store (mas-cli)"
      command: "mas install {{ item.id }}"
      loop: "{{ mas_apps }}"
      ignore_errors: true  # Ã‰vite que le playbook Ã©choue si une app est dÃ©jÃ  installÃ©e

    - name: "ğŸ“‚ Cloner les dotfiles"
      git:
        repo: "{{ dotfiles_repo }}"
        dest: "{{ dotfiles_path }}"
        version: main
        update: yes

    - name: "ğŸ”— CrÃ©er les liens symboliques pour les dotfiles"
      file:
        src: "{{ dotfiles_path }}/{{ item }}"
        dest: "{{ ansible_env.HOME }}/{{ item }}"
        state: link
        force: yes
      loop:
        - .gitconfig

    - name: "âš™ï¸ Modifier la configuration systÃ¨me (defaults write)"
      shell: |
        defaults write com.apple.finder AppleShowAllFiles -bool true
      args:
        executable: /bin/bash

    - name: "ğŸ”„ Lancer le playbook de configuration du clavier"
      include_tasks: keyboard_setup.yml

    - name: "ğŸ–±ï¸ Lancer le playbook de configuration du trackpad et de la souris"
      include_tasks: trackpad_and_mouse_setup.yml

    - name: "ğŸ“‚ Lancer le playbook de configuration du Dock"
      include_tasks: dock_setup.yml

    - name: "ğŸ” RedÃ©marrer le Dock et Finder"
      command: killall Dock Finder
      ignore_errors: true  # Ignore l'erreur si le processus n'existe pas

    - name: "ğŸ”‘ GÃ©nÃ©rer une nouvelle clÃ© SSH"
      command: ssh-keygen -t ed25519 "{{ ansible_env.HOME }}/.ssh/id_rsa" -N ""
      when: not ssh_key.stat.exists

    - name: "ğŸ“¤ Lire la clÃ© publique SSH"
      command: cat "{{ ansible_env.HOME }}/.ssh/ed25519.pub"
      register: ssh_pub_key

    - name: "ğŸ”’ DÃ©finir les permissions correctes sur les fichiers SSH"
      file:
        path: "{{ ansible_env.HOME }}/.ssh"
        state: directory
        mode: '0700'

    - name: "ğŸ”’ DÃ©finir les permissions correctes sur la clÃ© privÃ©e"
      file:
        path: "{{ ansible_env.HOME }}/.ssh/id_rsa"
        state: file
        mode: '0600'

    - name: "ğŸ”’ DÃ©finir les permissions correctes sur la clÃ© publique"
      file:
        path: "{{ ansible_env.HOME }}/.ssh/id_rsa.pub"
        state: file
        mode: '0644'

    - name: "ğŸš€ Afficher la clÃ© publique SSH"
      debug:
        msg: "ClÃ© SSH : {{ ssh_pub_key.stdout }}"

  post_tasks:
    - name: "âœ… Installation terminÃ©e"
      debug:
        msg: "La configuration de ton Mac est terminÃ©e ! RedÃ©marre pour appliquer tous les changements."